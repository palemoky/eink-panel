name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  DOCKERHUB_IMAGE: palemoky/eink-panel
  GHCR_IMAGE: ghcr.io/palemoky/eink-panel

jobs:
  # Run tests before building and publishing
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-suffix: v1

      - name: Install dependencies
        run: |
          uv sync --frozen --extra dev

      - name: Run tests
        run: |
          uv run pytest tests/

  # Build and publish Docker images to Docker Hub and GHCR
  build-and-push:
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Set up QEMU for multi-architecture builds (ARM64 for Raspberry Pi)
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Login to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Login to GitHub Container Registry
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Generate Docker metadata (tags and labels)
      - name: Extract metadata for Docker Hub
        id: meta-dockerhub
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKERHUB_IMAGE }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest,enable=${{ startsWith(github.ref, 'refs/tags/v') }}

      - name: Extract metadata for GHCR
        id: meta-ghcr
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.GHCR_IMAGE }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest,enable=${{ startsWith(github.ref, 'refs/tags/v') }}

      # Build and push to both Docker Hub and GHCR in one step
      - name: Build and push to Docker Hub and GHCR
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ steps.meta-dockerhub.outputs.tags }}
            ${{ steps.meta-ghcr.outputs.tags }}
          labels: ${{ steps.meta-dockerhub.outputs.labels }}
          # Multi-platform build: AMD64 (PC) and ARM64 (Raspberry Pi 3/4/5 64-bit)
          platforms: linux/amd64,linux/arm64
          # Docker cache disabled - UV cache already speeds up dependency installation
          # Avoids wasteful buildkit-blob-* cache files with low hit rate
          provenance: false
          sbom: false

      # Clean up old alpha/beta/rc images (keep only the latest 2 versions)
      - name: Clean up old pre-release images
        if: contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Cleaning up old pre-release images..."
          
          # Clean up GHCR old images (keep latest 2 pre-release versions)
          PACKAGE_NAME="${{ github.event.repository.name }}"
          OWNER="${{ github.repository_owner }}"
          
          echo "Fetching GHCR package versions for ${OWNER}/${PACKAGE_NAME}..."
          
          # Try org endpoint first, fall back to user endpoint
          # Get all versions with pre-release tags, sorted by created_at (newest first)
          VERSIONS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/orgs/${OWNER}/packages/container/${PACKAGE_NAME}/versions?per_page=100" \
            --jq '[.[] | select(.metadata.container.tags | length > 0) | select(.metadata.container.tags[] | test("alpha|beta|rc"))] | sort_by(.created_at) | reverse | .[2:] | .[] | {id: .id, tags: .metadata.container.tags, created_at: .created_at}' \
            2>/dev/null || \
          gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/users/${OWNER}/packages/container/${PACKAGE_NAME}/versions?per_page=100" \
            --jq '[.[] | select(.metadata.container.tags | length > 0) | select(.metadata.container.tags[] | test("alpha|beta|rc"))] | sort_by(.created_at) | reverse | .[2:] | .[] | {id: .id, tags: .metadata.container.tags, created_at: .created_at}')
          
          # Get version IDs to delete (skip the latest 2)
          VERSION_IDS=$(echo "$VERSIONS" | jq -r '.id')
          
          if [ -n "$VERSION_IDS" ]; then
            echo "Deleting old pre-release versions (keeping latest 2)..."
            echo "$VERSION_IDS" | while read version_id; do
              # Try org endpoint first, fall back to user endpoint
              gh api \
                --method DELETE \
                -H "Accept: application/vnd.github+json" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "/orgs/${OWNER}/packages/container/${PACKAGE_NAME}/versions/${version_id}" \
                2>/dev/null && echo "✓ Deleted version ID: $version_id" || \
              gh api \
                --method DELETE \
                -H "Accept: application/vnd.github+json" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "/users/${OWNER}/packages/container/${PACKAGE_NAME}/versions/${version_id}" \
                && echo "✓ Deleted version ID: $version_id" || \
                echo "✗ Failed to delete version ID: $version_id"
            done
          else
            echo "No old pre-release versions to delete (keeping latest 2)"
          fi
          
          # Clean up Docker Hub old images (keep latest 2 alpha versions)
          echo "Cleaning up Docker Hub pre-release images..."
          
          # Get Docker Hub token
          HUB_TOKEN=$(curl -s -H "Content-Type: application/json" -X POST \
            -d '{"username": "${{ secrets.DOCKERHUB_USERNAME }}", "password": "${{ secrets.DOCKERHUB_TOKEN }}"}' \
            https://hub.docker.com/v2/users/login/ | jq -r .token)
          
          # Get all tags
          REPO_NAME="${{ env.DOCKERHUB_IMAGE }}"
          TAGS=$(curl -s -H "Authorization: JWT ${HUB_TOKEN}" \
            "https://hub.docker.com/v2/repositories/${REPO_NAME}/tags/?page_size=100" \
            | jq -r '.results[] | select(.name | test("alpha|beta|rc")) | .name' \
            | sort -V)
          
          # Keep latest 2, delete others
          OLD_TAGS=$(echo "$TAGS" | head -n -2)
          
          if [ -n "$OLD_TAGS" ]; then
            echo "Deleting old tags: $OLD_TAGS"
            echo "$OLD_TAGS" | while read tag; do
              curl -X DELETE \
                -H "Authorization: JWT ${HUB_TOKEN}" \
                "https://hub.docker.com/v2/repositories/${REPO_NAME}/tags/${tag}/" \
                && echo "Deleted tag: $tag" \
                || echo "Failed to delete tag: $tag"
            done
          else
            echo "No old Docker Hub tags to clean"
          fi

      # Clean up untagged GHCR images (runs on every release)
      - name: Clean up untagged GHCR images
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Cleaning up untagged GHCR images (SHA256 digests)..."
          
          PACKAGE_NAME="${{ github.event.repository.name }}"
          OWNER="${{ github.repository_owner }}"
          
          # Get all untagged versions (try org first, fall back to user)
          UNTAGGED_IDS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/orgs/${OWNER}/packages/container/${PACKAGE_NAME}/versions?per_page=100" \
            --jq '.[] | select(.metadata.container.tags | length == 0) | .id' \
            2>/dev/null || \
          gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/users/${OWNER}/packages/container/${PACKAGE_NAME}/versions?per_page=100" \
            --jq '.[] | select(.metadata.container.tags | length == 0) | .id')
          
          if [ -n "$UNTAGGED_IDS" ]; then
            echo "Found $(echo "$UNTAGGED_IDS" | wc -l) untagged images to delete"
            echo "$UNTAGGED_IDS" | while read version_id; do
              gh api \
                --method DELETE \
                -H "Accept: application/vnd.github+json" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "/orgs/${OWNER}/packages/container/${PACKAGE_NAME}/versions/${version_id}" \
                2>/dev/null && echo "✓ Deleted untagged SHA256: $version_id" || \
              gh api \
                --method DELETE \
                -H "Accept: application/vnd.github+json" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "/users/${OWNER}/packages/container/${PACKAGE_NAME}/versions/${version_id}" \
                && echo "✓ Deleted untagged SHA256: $version_id" || \
                echo "✗ Failed to delete untagged SHA256: $version_id"
            done
          else
            echo "No untagged images to delete"
          fi

      # Notify on failure via Xiaomi Speaker
      - name: Notify via Xiaomi Speaker
        if: failure()
        env:
          MI_USER: ${{ secrets.MI_USER }}
          MI_PASS: ${{ secrets.MI_PASS }}
          MI_BOX_DID: ${{ secrets.MI_BOX_DID }}
          NOTIFY_MSG: "Alert: Release failed for ${{ github.repository }}"
        run: |
          uv pip install --system aiohttp aiofiles miservice
          python .github/scripts/notify_xiaomi_speaker.py

  # Sync README to Docker Hub (after successful image build)
  sync-readme:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Sync README to Docker Hub
        uses: peter-evans/dockerhub-description@v4
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: ${{ secrets.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}
          short-description: ${{ github.event.repository.description }}
          readme-filepath: ./README.md
